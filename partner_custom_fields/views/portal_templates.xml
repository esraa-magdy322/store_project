<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extend portal my details template to add custom fields -->
    <template id="portal_my_details_fields_custom" inherit_id="portal.portal_my_details_fields">
        <!-- Hide Company Name field -->
        <xpath expr="//input[@name='company_name']/.." position="replace"/>

        <!-- Add custom fields after the Country field -->
        <xpath expr="//select[@name='country_id']/.." position="after">
            <!-- Company Registry Field (standard field) -->
            <div t-attf-class="mb-3 #{error.get('company_registry') and 'o_has_error' or ''} col-xl-6">
                <label class="col-form-label label-optional" for="company_registry">Company ID</label>
                <input type="text" name="company_registry" t-attf-class="form-control #{error.get('company_registry') and 'is-invalid' or ''}" t-att-value="company_registry or partner.company_registry or ''" placeholder="Company Registration Number"/>
            </div>

            <!-- Expire Date Field (custom field) -->
            <div t-attf-class="mb-3 #{error.get('expire_date') and 'o_has_error' or ''} col-xl-6">
                <label class="col-form-label label-optional" for="expire_date">Expire Date</label>
                <input type="date" name="expire_date" t-attf-class="form-control #{error.get('expire_date') and 'is-invalid' or ''}" t-att-value="expire_date or partner.expire_date or ''" />
            </div>
        </xpath>
    </template>

    <!-- Add Attachments link to portal home -->
    <template id="portal_my_home_menu_attachments" name="Portal My Home : attachments entries" inherit_id="portal.portal_my_home" priority="50">
        <xpath expr="//div[@id='portal_common_category']" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t t-set="title">My Documents</t>
                <t t-set="url" t-value="'/my/attachments'"/>
                <t t-set="text">View and manage your documents</t>
                <t t-set="config_card" t-value="True"/>
            </t>
        </xpath>
    </template>

    <!-- Attachments Page Template -->
    <template id="portal_my_attachments" name="My Attachments">
        <t t-call="portal.portal_layout">
            <t t-set="additional_title">My Documents</t>
            <div class="o_portal_my_doc_table">
                <div class="row mb-4">
                    <div class="col-12">
                        <h3>My Documents</h3>
                        <p class="text-muted">Upload and manage your documents</p>
                    </div>
                </div>

                <!-- Upload Form -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Upload New Document</h5>
                    </div>
                    <div class="card-body">
                        <form action="/my/attachments/upload" method="post" enctype="multipart/form-data">
                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                            <div class="mb-3">
                                <label for="file" class="form-label">Choose File</label>
                                <input type="file" class="form-control" name="file" id="file" required="1"/>
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label">Description (Optional)</label>
                                <input type="text" class="form-control" name="description" id="description" placeholder="Enter file description"/>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fa fa-upload"/> Upload
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Attachments List -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">My Documents</h5>
                    </div>
                    <div class="card-body">
                        <t t-if="attachments">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>File Name</th>
                                            <th>Description</th>
                                            <th>Upload Date</th>
                                            <th>Size</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="attachments" t-as="attachment">
                                            <tr>
                                                <td>
                                                    <i t-attf-class="fa fa-file-o me-2"/>
                                                    <t t-esc="attachment.name"/>
                                                </td>
                                                <td>
                                                    <t t-esc="attachment.description or '-'"/>
                                                </td>
                                                <td>
                                                    <t t-esc="attachment.create_date.strftime('%Y-%m-%d %H:%M') if attachment.create_date else '-'"/>
                                                </td>
                                                <td>
                                                    <t t-esc="'%.2f KB' % (attachment.file_size / 1024) if attachment.file_size else '-'"/>
                                                </td>
                                                <td>
                                                    <a t-attf-href="/my/attachments/download/#{attachment.id}" class="btn btn-sm btn-primary me-1" title="Download">
                                                        <i class="fa fa-download"/>
                                                    </a>
                                                    <a t-attf-href="/my/attachments/delete/#{attachment.id}"
                                                       class="btn btn-sm btn-danger"
                                                       title="Delete"
                                                       onclick="return confirm('Are you sure you want to delete this file?');">
                                                        <i class="fa fa-trash"/>
                                                    </a>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </t>
                        <t t-else="">
                            <div class="alert alert-info text-center">
                                <i class="fa fa-info-circle"/> No documents uploaded yet.
                            </div>
                        </t>
                    </div>
                </div>
            </div>
        </t>
    </template>
</odoo>
